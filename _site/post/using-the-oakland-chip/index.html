<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="Cache-control" content="public">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <!-- site info -->
    <meta name="author" content="Jeremy Warner">
    <meta name="robots" content="index, follow">
    <meta name="keywords" content="jeremy warner, berkeley, human computer interaction, online education, computer science, hci">
    <meta name="description" content="I am an EECS Ph.D. student at UC Berkeley, and am advised by Björn Hartmann. My research focuses on systems-building human computer interaction work - check out some of my projects. Before this, I attended the University of Rochester, where I worked with Philip Guo.
">
    <title>
      
        jeremy warner - using the oakland chip
      
    </title>

    <!-- CSS -->
    <link rel="stylesheet" href="/src/css/main.css">
    <link rel="stylesheet" href="/src/css/syntax.css">
    <link rel="alternate" type="application/rss+xml" title="Bakery Store RSS" href="/feed.xml">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

    <!-- JS -->
    <script type="text/javascript" src="/src/js/ga.js" async></script>

    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/src/img/logo.png">
    <link rel="shortcut icon" href="/src/img/favicon.ico">

    <!-- Facebook -->
    <meta property="og:site_name"   content="Jeremy Warner"/>
    <meta property="og:description" content=" I am an EECS Ph.D. student at UC Berkeley, and am advised by Björn Hartmann. My research focuses on systems-building human computer interaction work - check out some of my projects. Before this, I attended the University of Rochester, where I worked with Philip Guo.
 " />
    <meta property="og:title"       content="Jeremy Warner  - using the oakland chip "/>
    <meta property="og:image"       content="  " />
  </head>
  <body>

    <div class="wrap">
      <!-- responsive masthead -->
      <div class="masthead">
        <div class="container">
          <div class="nav">
            <a href="/" title="home">home</a>
            <a href="/blog" title="blog">blog</a>
            <a href="https://twitter.com/jeremywrnr" target="_blank" title="twitter">twitter</a>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="post-header">
    <h1 class="post-title" >Using The Oakland Chip</h1>
    <span class="post-meta">written feb 9, 2017</span>
    </br> <span class="post-meta"> by <a href="/">jeremy b. warner</a></span>
</div>

<p>My project group for <a href="http://hci.berkeley.edu/devicedesign/">Interactive Device Design</a> used Oakland’s CHIP as
the brains of our final project: <a href="/project/mewsician">mewsician</a>, your musical
companion. Mewsician’s goal was to provide more intrinsic motivation to young
‘mewsicians’, and was a blast to design and manufacture. Here, I will go over
takeaways I had from working with the CHIP. I may add to this later, as I have
been playing around with a PocketCHIP recently.</p>

<p><img src="/src/img/oakland-chip.jpg" alt="oakland chip" /></p>

<p>The <a href="https://getchip.com/">CHIP</a> is an innovative and accessible piece of
hardware. The product sells at just <em>$9</em>, and is about as powerful as an iPhone
4s from 2011. The company has <a href="http://www.mercurynews.com/2016/02/08/for-oakland-startup-a-9-computer-about-more-than-getting-rich/">spoken</a> on how they are enthusiastically
supporting hardware for educational and hobbyist purposes. This is incredible
work from my perspective - I remember playing BlockDude and programming a
quadratic equation solver in high school on a TI-83, which somehow still
<a href="https://www.amazon.com/Texas-Instruments-TI-83-Graphing-Calculator/dp/B00001N2QU">retails</a> at over ten times the price of a CHIP. I eagerly anticipate what
upcoming generations of students and makers will do with better access to using
embedded computation creatively, and applaud <a href="https://twitter.com/nextthingco?lang=en">The Next Thing</a>’s progress
towards the democratization of technology. On the other hand, naming your
electronics device ‘CHIP’ makes finding documentation kind of arduous
¯\_(ツ)_/¯</p>

<h3 id="overview">overview</h3>

<p>Our system used a range of the CHIP’s abilities, including: GPIO, audio input
and output, networking, and <code class="highlighter-rouge">systemd</code> configuration. Using the CHIP to generate
output from audio from files was relatively easy, and most of the issues we ran
into were around trying to record audio. CHIP has several general purpose
input/output (GPIO) pins which could be used to trigger playing the audio, and
there are python libraries for interfacing with the board’s GPIO. It is more
complex than an Arduino for this, though… you either have to connect to the
board and start the python script or configure the board so it starts the
script whenever it is powered on. Additionally, the timing requirements are not
tight enough to power Adafruit’s <a href="https://www.adafruit.com/products/1463">neopixels</a>, so instead we had the CHIP
power an Arduino Nano to directly control it. Still, it is an robust,
accessible (and <a href="https://github.com/NextThingCo/CHIP-Hardware">open-source</a>!!!) development platform with a solid
community and detailed documentation.</p>

<ul>
  <li><a href="#startup-commands">starting up</a></li>
  <li><a href="#boot-processes">boot processes</a></li>
  <li><a href="#audio-stack-overview">using audio</a></li>
  <li><a href="#resources">resources</a></li>
</ul>

<h3 id="startup-commands">startup commands</h3>

<p>There are several configuration steps that have to be done when working with
the CHIP. One notable advantage of using the chip is that it can run headless
(without an external monitor). You can setup a direct ssh line into them, or
use screen to access them. Here are commands that we noted during our time
setting up the CHIP, which potentially could be useful when getting started:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># list wifi spots</span>
nmcli device wifi list

<span class="c"># connect to wifi (can be saved as a bash function)</span>
sudo nmcli device wifi connect <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> password <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> ifname wlan0

<span class="c"># turn off wifi</span>
sudo nmcli dev disconnect wlan0

<span class="c"># check internet connectivity</span>
ping 8.8.8.8

<span class="c"># setup ssh agent</span>
sudo apt-get install avahi-daemon

<span class="c"># restart mew (systemd) service</span>
sudo systemctl restart mew
</code></pre>
</div>

<p>We also have a general setup scripts, which could contain something useful, but
also contains some system specific requirements (comments included). The
<a href="https://docs.getchip.com/chip.html#introduction">official guide</a> for the CHIP helped us get started quickly.</p>

<h3 id="boot-processes">boot processes</h3>

<p>An Arduino starts running whatever code was loaded onto it when it receives
power, but CHIP is a full Linux computer so start up commands can either be set
through a GUI, or if you are running it headless like I was, then with the
<code class="highlighter-rouge">systemd</code> service. Here is the <code class="highlighter-rouge">systemd</code> boot configuration for this project.
It was titled <code class="highlighter-rouge">mew.service</code>, and in general should end in <code class="highlighter-rouge">.service</code>. This file
tells your CHIP that when you turn it on, it should start running a certain
script or program.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[Unit]
Description=mewsichip
After=default.target

[Service]
ExecStart=/home/chip/mewsichip/start
Type=simple

[Install]
WantedBy=default.target
</code></pre>
</div>

<p>For example, this is the script that is the argument for <code class="highlighter-rouge">Service/ExecStart</code>
in the system configuration file above. It kills any running audio processes
that could be running, sets the working directory to where the startup script
is located in the file system, resets the CHIP’s GPIO configuration and
then finally starts running the main python script that we setup.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># kill any remaining audio procs</span>
ps aux | grep record | head -n3 | awk <span class="s1">'{ print $2 }'</span> | xargs -L 1 sudo <span class="nb">kill</span>

<span class="c"># getting the current working directory</span>
<span class="c"># https://stackoverflow.com/questions/59895</span>
<span class="nv">DIR</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">"</span><span class="k">$(</span> dirname <span class="s2">"</span><span class="k">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="k">}</span><span class="s2">"</span> <span class="k">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> <span class="k">)</span><span class="s2">"</span>

<span class="c"># free up any exported GPIOs</span>
sudo bash <span class="s2">"</span><span class="nv">$DIR</span><span class="s2">/script/unexport.sh"</span>

<span class="c"># beginning running mewsician, w/o warnings, and pass in auth</span>
sudo python -W ignore <span class="s2">"</span><span class="nv">$DIR</span><span class="s2">/python/mewsicode.py"</span> <span class="k">$(</span>cat <span class="s2">"</span><span class="nv">$DIR</span><span class="s2">/chip.auth"</span><span class="k">)</span>
</code></pre>
</div>

<p>[<a href="https://github.com/jeremywrnr/mewsichip/blob/master/script/unexport.sh">Here</a>]
is the <code class="highlighter-rouge">unexport</code> script we used to free up the GPIO pins, and
[<a href="https://github.com/jeremywrnr/mewsichip/blob/master/python/mewsicode.py">here</a>]
is the link to our main python application code, <code class="highlighter-rouge">mewsicode.py</code>. It had a
similar setup and loop structure that is common in Arduino programs.</p>

<h3 id="audio-stack-overview">audio stack overview</h3>

<ul>
  <li><a href="#recording-audio">record</a>: getting and saving audio source data</li>
  <li><a href="#playing-audio">output</a>: given a file, generating actual noise from the chip</li>
  <li><a href="#uploading-files">upload</a>: sending audio file to cloud storage service</li>
</ul>

<h4 id="recording-audio">recording audio</h4>

<p>I found help from <a href="https://stackoverflow.com/questions/6867675/audio-recording-in-python">stack
overflow</a>.
This is a handy script for recording audio because it shows you the amplitude
of the input wave as it comes into your system in a numerical form, so visually
discerning whether recording is working (roughly) correctly is facile. There
was a header we soldered to try and get it work, but I am unsure if it actually
was needed. We were getting some <a href="https://twitter.com/jingyeezy/status/799124816880025600">odd</a> feedback while trying to record
audio through the headers, so we ended up getting a headphone splitter in order
to access both the microphone and the CHIP’s audio output.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># show amplitude while recording</span>

<span class="kn">import</span> <span class="nn">alsaaudio</span><span class="o">,</span> <span class="nn">wave</span><span class="o">,</span> <span class="nn">numpy</span>

<span class="n">inp</span> <span class="o">=</span> <span class="n">alsaaudio</span><span class="o">.</span><span class="n">PCM</span><span class="p">(</span><span class="n">alsaaudio</span><span class="o">.</span><span class="n">PCM_CAPTURE</span><span class="p">)</span>
<span class="n">inp</span><span class="o">.</span><span class="n">setchannels</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">inp</span><span class="o">.</span><span class="n">setrate</span><span class="p">(</span><span class="mi">44100</span><span class="p">)</span>
<span class="n">inp</span><span class="o">.</span><span class="n">setformat</span><span class="p">(</span><span class="n">alsaaudio</span><span class="o">.</span><span class="n">PCM_FORMAT_S16_LE</span><span class="p">)</span>
<span class="n">inp</span><span class="o">.</span><span class="n">setperiodsize</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

<span class="c"># test.wav is file written to</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">wave</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'test.wav'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">setnchannels</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">setsampwidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">setframerate</span><span class="p">(</span><span class="mi">44100</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">'int16'</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">numpy</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">w</span><span class="o">.</span><span class="n">writeframes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="playing-audio">playing audio</h4>

<p>This was the smoothest part of working with the CHIP. There are plenty of
players out there (aplay, mplayer, etc), and playing back audio from the CHIP
was seamless. Given an audio file <code class="highlighter-rouge">test.wav</code>, you could just hook up headphones
or a speaker with an AUX cord and run <code class="highlighter-rouge">mplayer test.wav</code> to play it - easy.</p>

<h4 id="uploading-files">uploading files</h4>

<p>Once we were able to get a solid stream of audio coming in, we directed the
audio stream to to a file locally, and then finally uploaded it to the ~cloud~,
where we had a server running on Heroku. Starting out, we just used a simple
library to make PUT requests to our server:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">gmtime</span><span class="p">,</span> <span class="n">strftime</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">make_requests</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://mewsician.herokuapp.com/demotime"</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'data'</span><span class="p">:</span>
        <span class="s">"Hello Mewsician, here's a random number: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
        <span class="p">})</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">make_requests</span><span class="p">()</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre>
</div>

<p>Eventually, we used python to attach the file to upload (reference from our
python main source file), externally calling <code class="highlighter-rouge">curl</code> at the system level to make
a more complicated PUT request involving a form:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># stop current recording, compress file format</span>
<span class="c"># trigger external uploading if connected to the network</span>
<span class="k">def</span> <span class="nf">upload</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">mname</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Stopping recording..."</span><span class="p">)</span>
    <span class="n">mpid</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span> <span class="c"># from record()</span>
    <span class="n">mname</span> <span class="o">=</span> <span class="n">bname</span> <span class="o">+</span> <span class="s">".mp3"</span>

    <span class="c"># stopped recording, update arduino lights</span>
    <span class="n">send_serial</span><span class="p">(</span><span class="s">'u'</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"Compressing audio..."</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">'sudo'</span><span class="p">,</span> <span class="s">'chown'</span><span class="p">,</span> <span class="s">'chip:chip'</span><span class="p">,</span> <span class="n">fname</span><span class="p">])</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">'lame'</span><span class="p">,</span> <span class="s">'-V2'</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">mname</span><span class="p">])</span> <span class="c"># convert</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">'sudo'</span><span class="p">,</span> <span class="s">'chown'</span><span class="p">,</span> <span class="s">'chip:chip'</span><span class="p">,</span> <span class="n">mname</span><span class="p">])</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"Uploading music..."</span><span class="p">)</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="s">'auth='</span> <span class="o">+</span> <span class="n">authentication</span> <span class="c"># upload</span>
    <span class="n">path</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">mname</span>
    <span class="n">upload</span> <span class="o">=</span> <span class="s">'file=@'</span> <span class="o">+</span> <span class="n">path</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">'curl'</span><span class="p">,</span> <span class="s">'--form'</span><span class="p">,</span> <span class="n">upload</span><span class="p">,</span> <span class="s">'--form'</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="s">'http://mewsician.win/upload'</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span> <span class="c"># if upload fails (no network connection), write it to a queue</span>
        <span class="k">print</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Cleaning up..."</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">'mv'</span><span class="p">,</span> <span class="s">'-v'</span><span class="p">,</span> <span class="n">mname</span><span class="p">,</span> <span class="n">audioLoc</span><span class="p">])</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">'rm'</span><span class="p">,</span> <span class="s">'-v'</span><span class="p">,</span> <span class="n">fname</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Complete."</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">audioLoc</span> <span class="o">+</span> <span class="s">"queue"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mname</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</code></pre>
</div>

<p>Please <a href="https://twitter.com/jeremywrnr">get in touch</a> with any feedback or
questions. Thanks for reading!</p>

<h3 id="resources">resources</h3>

<ul>
  <li><a href="http://mewsician.win">mewsician website</a></li>
  <li><a href="https://github.com/radiolarian/mewsician">mewsician github repo</a></li>
  <li><a href="http://docs.getchip.com/chip.html#physical-connectors">chip gpio documentation</a></li>
  <li><a href="https://cdn-shop.adafruit.com/product-files/1699/STX3120.pdf">adafruit headphone schematic</a></li>
  <li><a href="https://github.com/fordsfords/blink">systemd CHIP setup help</a></li>
  <li><a href="http://www.cablechick.com.au/resources/image/trrs-diagram2.jpg">headphone jack diagram</a></li>
  <li><a href="https://docs.getchip.com/chip.html">general chip docs</a></li>
</ul>



<!--sort and link the separate posts chronologically-->





<script>
document.body.onkeyup = function(e) {
  if (e.keyCode == '37') { window.location = ''; }
  if (e.keyCode == '39') { window.location = '/post/m4a-to-mp3-conversion/'; }
};
</script>

<span class="post-meta">
    <a href="mailto:jeremy.warner@berkeley.edu">email</a> /
    <a href="https://twitter.com/jeremywrnr">tweet</a>
</span>

<div class="masthead">
  
  <a href="/blog">all</a>
   <a href="/post/m4a-to-mp3-conversion/" class="nxt">next</a>
</div>


      </div>
    </div>

  </body>
</html>
